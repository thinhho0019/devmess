name: CI/CD Pipeline webchat devmess

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # ---------- FRONTEND (React Vite) ----------
  frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: client

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          cache-dependency-path: client/package-lock.json
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test -- --watchAll=false

      - name: Create .env file for production
        env:
          VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: echo "VITE_WS_URL=${VITE_WS_URL}" > .env

      - name: Build Vite project
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: client/dist

  # ---------- BACKEND (Go) ----------
  backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Install dependencies
        run: go mod tidy

      - name: Run Go tests
        run: go test ./...

      - name: Build Go binary
        run: go build -o app main.go

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: server/app

      - name: Create .env
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URL: ${{ secrets.GOOGLE_REDIRECT_URL }}
          DEFAULT_URL: ${{ secrets.DEFAULT_URL }}
          DEFAULT_URL_SERVER: ${{ secrets.DEFAULT_URL_SERVER }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SPACES_KEY: ${{ secrets.SPACES_KEY }}
          SPACES_SECRET: ${{ secrets.SPACES_SECRET }}
          SPACES_REGION: ${{ secrets.SPACES_REGION }}
          SPACES_BUCKET: ${{ secrets.SPACES_BUCKET }}
          SPACES_ENDPOINT: ${{ secrets.SPACES_ENDPOINT }}
        run: |
          cat > .env <<EOF
          DB_HOST=${DB_HOST}
          DB_PORT=${DB_PORT}
          DB_USER=${DB_USER}
          DB_PASSWORD=${DB_PASSWORD}
          DB_NAME=${DB_NAME}
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
          GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
          DEFAULT_URL=${DEFAULT_URL}
          DEFAULT_URL_SERVER=${DEFAULT_URL_SERVER}
          JWT_SECRET_KEY=${JWT_SECRET_KEY}
          SMTP_EMAIL=${SMTP_EMAIL}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          SPACES_KEY=${SPACES_KEY}
          SPACES_SECRET=${SPACES_SECRET}
          SPACES_REGION=${SPACES_REGION}
          SPACES_BUCKET=${SPACES_BUCKET}
          SPACES_ENDPOINT=${SPACES_ENDPOINT}
          EOF

      - name: Check .env location
        run: |
          ls -la .
          pwd
          cat .env | head -3
          
      - name: Debug .env
        run: |
          echo "PWD: $(pwd)"
          ls -la server/

      - name: Upload .env file
        uses: actions/upload-artifact@v4
        with:
          name: backend-env
          path: .env

    # ---------- DEPLOY ----------
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [frontend, backend]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: ./server_bin # tải binary về thư mục server_bin/

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./frontend_dist

      - name: Download backend .env
        uses: actions/download-artifact@v4
        with:
          name: backend-env
          path: ./server_env

      - name: Copy files to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "frontend_dist,server_bin/app,server_env/.env"
          target: /var/www/devmess
      - name: Create redis and postgres services on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # --- Create Redis service ---
            if ! command -v redis-server &> /dev/null; then
              sudo apt update -y && sudo apt install -y redis-server
            fi

            sudo bash -c 'cat > /etc/systemd/system/redis.service <<EOF
            [Unit]
            Description=Redis In-Memory Data Store
            After=network.target

            [Service]
            User=redis
            Group=redis
            ExecStart=/usr/bin/redis-server /etc/redis/redis.conf
            ExecStop=/usr/bin/redis-cli shutdown
            Restart=always

            [Install]
            WantedBy=multi-user.target
            EOF'

            sudo systemctl daemon-reload
            sudo systemctl enable redis.service
            sudo systemctl start redis.service
            echo "✅ Redis service is running!"

            # --- Create PostgreSQL service ---
            if ! command -v psql &> /dev/null; then
              sudo apt update -y && sudo apt install -y postgresql postgresql-contrib
              sudo -u postgres psql -c "CREATE USER ${{ secrets.DB_USER }} WITH PASSWORD '${{ secrets.DB_PASSWORD }}';"
              sudo -u postgres psql -c "CREATE DATABASE ${{ secrets.DB_NAME }} OWNER ${{ secrets.DB_USER }};"
              echo "✅ PostgreSQL user and database created!"
              sudo systemctl enable postgresql
              sudo systemctl start postgresql
              echo "✅ PostgreSQL service is running!"
            fi
        
      - name: Deploy Backend & Setup Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/devmess
            echo "🔑 Granting execute permission..."
            sudo chmod +x server_bin/app

            # Copy .env to correct location
            echo "📋 Moving .env file..."
            cp server_env/.env .env || echo "⚠️ .env file not found"
            ls -la .env || echo "⚠️ .env verification failed"

            echo "⚙️ Creating systemd service..."
            sudo bash -c 'cat > /etc/systemd/system/devmess-backend.service <<EOF
            [Unit]
            Description=Go Backend for Devmess
            After=network.target

            [Service]
            User=root
            WorkingDirectory=/var/www/devmess
            ExecStart=/var/www/devmess/server_bin/app
            Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            Restart=always

            [Install]
            WantedBy=multi-user.target
            EOF'

            sudo systemctl daemon-reload
            sudo systemctl enable devmess-backend.service
            sudo systemctl restart devmess-backend.service
            
            # Check service status
            echo "🔍 Checking service status..."
            sudo systemctl status devmess-backend.service --no-pager -l
            echo "✅ Backend deployment complete!"

            # --- Setup Nginx ---
            if ! command -v nginx &> /dev/null; then
              sudo apt update -y && sudo apt install -y nginx
            fi

            sudo bash -c 'cat > /etc/nginx/sites-available/devmess <<EOF
            server {
                listen 80;
                server_name devmess.cloud www.devmess.cloud;

                root /var/www/devmess/frontend_dist;
                index index.html;

                location / {
                    try_files \$uri /index.html;
                }

                location /ws {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "Upgrade";
                    proxy_set_header Host \$host;
                }
            }
            EOF'

            sudo ln -sf /etc/nginx/sites-available/devmess /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx
            echo "✅ Nginx setup complete!"
